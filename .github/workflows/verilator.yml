name: Verilator CI

on:
  push:
    branches: [ main ]
    paths-ignore:
      - outputs/wave.vcd   # prevent infinite loop
  pull_request:

permissions:
  contents: write   # REQUIRED to push back to repo

jobs:
  build-and-sim:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Install dependencies
      run: sudo apt-get update && sudo apt-get install -y verilator g++ make xvfb gtkwave curl

    - name: Install vcd2svg
      run: |
        curl -L -o /usr/local/bin/vcd2svg \
          https://github.com/cksystemsteaching/vcd2svg/releases/latest/download/vcd2svg-linux-x64
        chmod +x /usr/local/bin/vcd2svg

    - name: Run SV testbench
      run: |
        verilator -sv src/*.sv test/tb.sv \
          --binary \
          --trace \
          --timing \
          -Mdir obj_dir_sv
        ./obj_dir_sv/Vtop | tee sim.log

    - name: Save waveform to repo
      run: |
        mkdir -p outputs
        mv obj_dir_sv/wave.vcd outputs/wave.vcd

    - name: Generate waveform PNG (headless)
      run: |
        Xvfb :99 -screen 0 1920x1080x24 &
        export DISPLAY=:99
        gtkwave -a outputs/wave.vcd -o outputs/wave.png

    - name: Generate waveform SVG (vcd2svg)
      run: |
        /usr/local/bin/vcd2svg outputs/wave.vcd -o outputs/wave.svg

    - name: Commit waveform
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add outputs/wave.vcd
        git commit -m "CI: update waveform (wave.vcd)" || echo "No changes to commit"
        git push

    - name: Upload simulation output
      uses: actions/upload-artifact@v4
      with:
        name: sim-output
        path: |
          sim.log
          outputs/wave.vcd
          outputs/wave.png
          outputs/wave.svg

    - name: Write job summary
      run: |
        echo "## Verilator Simulation Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Simulation completed" >> $GITHUB_STEP_SUMMARY
        echo "- Log file: \`sim.log\`" >> $GITHUB_STEP_SUMMARY
        echo "- Waveform file: \`outputs/wave.vcd\`" >> $GITHUB_STEP_SUMMARY
        echo "- Waveform preview image:" >> $GITHUB_STEP_SUMMARY
        echo "![Waveform](outputs/wave.png)" >> $GITHUB_STEP_SUMMARY
        echo "- Waveform SVG preview:" >> $GITHUB_STEP_SUMMARY
        echo "![Waveform SVG](outputs/wave.svg)" >> $GITHUB_STEP_SUMMARY
        echo "- Live Waveform Viewer (Surfer): https://app.surfer-project.org" >> $GITHUB_STEP_SUMMARY
        echo "- Load waveform from this URL (in Surfer): https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/main/outputs/wave.vcd" >> $GITHUB_STEP_SUMMARY