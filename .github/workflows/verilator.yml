name: Verilator CI

on:
  push:
    branches: [ main ]
    paths-ignore:
      - outputs/wave.vcd   # prevent infinite loop
  pull_request:

permissions:
  contents: write   # REQUIRED to push back to repo

jobs:
  build-and-sim:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Install dependencies
      run: sudo apt-get update && sudo apt-get install -y verilator g++ make

    - name: Run SV testbench
      run: |
        verilator -sv src/*.sv test/tb.sv \
          --binary \
          --trace \
          --timing \
          -Mdir obj_dir_sv
        echo "------------------ Running testbench -------------------"
        ./obj_dir_sv/Vtop | tee sim.log
        echo "------------------- Test complete ----------------------"

    - name: Save waveform to repo
      run: |
        mkdir -p outputs
        mv obj_dir_sv/wave.vcd outputs/wave.vcd

    - name: Commit waveform
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add outputs/wave.vcd
        git commit -m "CI: update waveform (wave.vcd)" || echo "No changes to commit"
        git push

    - name: Upload simulation output
      uses: actions/upload-artifact@v4
      with:
        name: sim-output
        path: |
          sim.log
          outputs/wave.vcd

    - name: Write job summary
      run: |
        echo "## Verilator Simulation Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Simulation completed" >> $GITHUB_STEP_SUMMARY
        echo "- Log file: \`sim.log\`" >> $GITHUB_STEP_SUMMARY
        echo "- Waveform file: \`outputs/wave.vcd\`" >> $GITHUB_STEP_SUMMARY
        RAW_URL="https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/main/outputs/wave.vcd"
        ENCODED_URL=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$RAW_URL', safe=''))")
        echo "- Live waveform (Surfer): https://surfer-project.org/?url=$ENCODED_URL" >> $GITHUB_STEP_SUMMARY
  # https://raw.githubusercontent.com/SattiDaBeaver/ASIC-Hackathon-Template/main/outputs/wave.vcd
        

  # Waveform Viewer
  # viewer:
  #   needs: build-and-sim
  #   runs-on: ubuntu-latest
  #   permissions:
  #     pages: write
  #     id-token: write
  #   steps:
  #     - uses: actions/checkout@v3

  #     - uses: actions/download-artifact@v4
  #       with:
  #         name: sim-output

  #     - name: Prepare viewer
  #       run: |
  #         mkdir -p viewer
  #         cp wave.vcd viewer/
  #         cat > viewer/index.html << 'EOF'
  #         <!DOCTYPE html>
  #         <html>
  #         <body style="margin:0">
  #           <iframe
  #             src="https://app.surfer-project.org/"
  #             style="width:100vw;height:100vh;border:none">
  #           </iframe>
  #         </body>
  #         </html>
  #         EOF

  #     - uses: actions/upload-pages-artifact@v3
  #       with:
  #         path: viewer

  #     - uses: actions/deploy-pages@v4


    # # Option 2: Run C++ testbench
    # - name: Run C++ testbench
    #   run: |
    #     verilator src/*.sv --cc tb/sim_main.cpp --trace -Mdir obj_dir_cpp
    #     make -C obj_dir_cpp -f Vtop_module.mk
    #     ./obj_dir_cpp/Vtop_module
